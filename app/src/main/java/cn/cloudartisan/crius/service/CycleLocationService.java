/**
  * Generated by smali2java 1.0.0.558
  * Copyright (C) 2013 Hensence.com
  */

package cn.cloudartisan.crius.service;

import android.app.Service;
import android.content.Intent;
import android.os.IBinder;
import android.util.Log;
import com.baidu.location.BDLocation;
import com.baidu.location.BDLocationListener;
import com.baidu.location.LocationClient;
import com.baidu.location.LocationClientOption;
import cn.cloudartisan.crius.client.android.CIMPushManager;
import cn.cloudartisan.crius.client.model.SentBody;
import cn.cloudartisan.crius.app.ClientConfig;
import cn.cloudartisan.crius.app.Global;
import cn.cloudartisan.crius.bean.User;

public class CycleLocationService extends Service implements BDLocationListener {
    private LocationClient mLocationClient;
    User self;
    static final String TAG = CycleLocationService.class.getSimpleName();
    
    public void onCreate() {
        if(mLocationClient == null) {
            mLocationClient = new LocationClient(getApplicationContext());
            LocationClientOption option = new LocationClientOption();
            option.setLocationMode(LocationClientOption.LocationMode.Battery_Saving);
            option.setCoorType("bd09ll");
            option.setIsNeedAddress(true);
           mLocationClient.setLocOption(option);
            mLocationClient.registerLocationListener(this);
            mLocationClient.start();
        }
    }
    
    public int onStartCommand(Intent intent, int flags, int startId) {
        if(mLocationClient != null) {
            mLocationClient.requestLocation();
        }
        return 0x1;
    }
    
    public void onReceiveLocation(BDLocation location) {
        self = Global.getCurrentUser();
        if((location != null) && (self != null)) {
            double latitude = location.getLatitude();
            double longitude = location.getLongitude();
            SentBody sent = new SentBody();
            sent.setKey("client_cycle_location");
            sent.put("account", self.getAccount());
            sent.put("latitude", String.valueOf(latitude));
            sent.put("longitude", String.valueOf(longitude));
            sent.put("location", location.getAddrStr());
            CIMPushManager.sendRequest(this, sent);
            self.setLatitude(String.valueOf(latitude));
            self.setLongitude(String.valueOf(longitude));// = ;
            self.setLocation(location.getAddrStr()); //= ;
            Global.setCurrentUser(self);
            ClientConfig.setCurrentRegion(location.getCity());
            Log.i(TAG, "*******************\u5b9a\u4f4d\u6210\u529f:" + location.getAddrStr());
        }
    }
    
    public void onDestroy() {
        if(mLocationClient != null) {
            mLocationClient.stop();
        }
        mLocationClient = null;
    }
    
    public IBinder onBind(Intent intent) {
        return null;
    }
}
