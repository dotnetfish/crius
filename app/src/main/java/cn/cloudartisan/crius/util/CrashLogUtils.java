/**
  * Generated by smali2java 1.0.0.558
  * Copyright (C) 2013 Hensence.com
  */

package cn.cloudartisan.crius.util;

import android.os.Build;
import cn.cloudartisan.crius.app.Constant;
import cn.cloudartisan.crius.network.FileUploader;
import org.apache.commons.io.IOUtils;

import java.io.File;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.text.SimpleDateFormat;
import java.util.Date;

public class CrashLogUtils implements FileUploader.OnUploadCallBack {
    private static CrashLogUtils crashLogUtils;
    
    private CrashLogUtils() {
    }
    
    public static CrashLogUtils getInstace() {
        if(crashLogUtils == null) {
            crashLogUtils = new CrashLogUtils();
        }
        return crashLogUtils;
    }
    
    public void saveErrorLogToFile(Throwable ex) {
        StringWriter writer = new StringWriter();
        PrintWriter pw = new PrintWriter(writer);
        ex.printStackTrace(pw);
        Throwable cause = ex.getCause();
        while(cause != null) {
            cause.printStackTrace(pw);
            cause = cause.getCause();
        }
        pw.close();
        String log = writer.toString();
        saveTologFile(log);
    }
    
    private void saveTologFile(String log) {
        FileWriter fw = null;
        PrintWriter pw = null;
        try {
            File logFile = new File(Constant.LOG_DIR, "crash.log");
            if(!logFile.exists()) {
                logFile.createNewFile();
            }
             fw = new FileWriter(logFile, true);
             pw = new PrintWriter(fw);
            pw.print("\r\n");
            pw.flush();
            fw.flush();
        } catch(Exception localException1) {
        } finally {
            IOUtils.closeQuietly(fw);
            IOUtils.closeQuietly(pw);
        }
    }
    
    public void uploadCrashLogFile() {
        File localFile = new File(Constant.LOG_DIR, "crash.log");
        SimpleDateFormat localSimpleDateFormat = new SimpleDateFormat("yyy_MM_dd_HH_mm_ss");
        if (localFile.exists()) {
            FileUploader.asyncUpload("lvxin-crash-log", "crash_" + localSimpleDateFormat.format(new Date()) + "_v" + Build.VERSION.SDK_INT + ".log", localFile, this);
        }
    }

    public void complete(String paramString, File paramFile)
    {
        SimpleDateFormat sdf = new SimpleDateFormat("yyy_MM_dd_HH_mm_ss");
        paramFile.renameTo(new File(Constant.LOG_DIR, "crash_" + sdf.format(new Date()) + ".log"));
    }
    
    public void failed(Exception e, String key) {
    }
    
    public void onProgress(String key, float progress) {
    }
}
