/**
  * Generated by smali2java 1.0.0.558
  * Copyright (C) 2013 Hensence.com
  */

package cn.cloudartisan.crius.ui.trend;

import android.content.Intent;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ListView;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;
import cn.cloudartisan.crius.client.constant.CIMConstant;
import cn.cloudartisan.crius.R;
import cn.cloudartisan.crius.adapter.CircleMessageAdapter;
import cn.cloudartisan.crius.app.Global;
import cn.cloudartisan.crius.app.URLConstant;
import cn.cloudartisan.crius.bean.Article;
import cn.cloudartisan.crius.bean.Message;
import cn.cloudartisan.crius.bean.Page;
import cn.cloudartisan.crius.bean.User;
import cn.cloudartisan.crius.db.ArticleDBManager;
import cn.cloudartisan.crius.db.MessageDBManager;
import cn.cloudartisan.crius.network.HttpAPIRequester;
import cn.cloudartisan.crius.network.HttpAPIResponser;
import cn.cloudartisan.crius.ui.base.BaseActivity;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class CircleMessageListActivity extends BaseActivity implements AdapterView.OnItemClickListener, HttpAPIResponser {
    protected CircleMessageAdapter adapter;
    private List<Message> dataList=new ArrayList<>();
    ListView messageListView;
    HttpAPIRequester requester;
    User self;
    
    public void initComponents() {
        setDisplayHomeAsUpEnabled(true);
        self = Global.getCurrentUser();
        dataList.addAll(MessageDBManager.getManager().queryMoments());
        adapter = new CircleMessageAdapter(this, dataList);
        messageListView = (ListView)findViewById(R.id.messageListView);
        messageListView.setAdapter(adapter);
        messageListView.setOnItemClickListener(this);
        MessageDBManager.getManager().batchReadMessage(new String[] {"801", "802"});
        requester = new HttpAPIRequester(this);
    }
    
    public void onItemClick(AdapterView<?> arg0, View arg1, int index, long arg3) {
        String articleId = JSON.parseObject((dataList.get(index)).content).getString("articleId");
        Article article = ArticleDBManager.getManager().queryById(articleId);
        if(article != null) {
            Intent intent = new Intent(this, ArticleDetailedActivity.class);
            intent.putExtra("article", ArticleDBManager.getManager().queryById(articleId));
            startActivity(intent);
            return;
        }
        showProgressDialog(getString(R.string.tip_loading, new Object[] {getString(R.string.common_handle)}));
        apiParams.put("gid", articleId);
        requester.execute(new TypeReference<CircleMessageListActivity>() {}.getType(), null, URLConstant.ARTICLE_DETAILED_URL);
        messageListView.setTag(dataList.get(index));
    }
    
    public void onClick(View view) {
    }
    
    public void onSuccess(Object data, List list, Page page, String code, String url) {
        hideProgressDialog();
        if(data == null) {
            if(CIMConstant.ReturnCode.CODE_200.equals(code)) {
                Message notice = (Message)messageListView.getTag();
                showToast(R.string.tip_article_deleted);
                dataList.remove(notice);
                adapter.notifyDataSetChanged();
                MessageDBManager.getManager().deleteById(notice.gid);
            }
            return;
        }
        Intent intent = new Intent(this, ArticleDetailedActivity.class);
        intent.putExtra("article",(Article) data);

        startActivity(intent);
    }
    
    public void onFailed(Exception e) {
        hideProgressDialog();
    }
    
    public Map getRequestParams(String code) {
        return apiParams;
    }
    
    public void onRequest() {
    }
    
    public int getConentLayout() {
        return R.layout.activity_circle_message;
    }
    
    public int getActionBarTitle() {
        return R.string.label_circle_message;
    }
}
