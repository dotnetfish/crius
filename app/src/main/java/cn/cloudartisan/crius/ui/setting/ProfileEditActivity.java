/**
  * Generated by smali2java 1.0.0.558
  * Copyright (C) 2013 Hensence.com
  */

package cn.cloudartisan.crius.ui.setting;

import android.content.Intent;
import android.net.Uri;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.ImageView;
import android.widget.TextView;
import com.nostra13.universalimageloader.cache.disc.naming.Md5FileNameGenerator;
import com.nostra13.universalimageloader.core.ImageLoader;
import cn.cloudartisan.crius.client.android.CIMPushManager;
import cn.cloudartisan.crius.client.model.SentBody;
import cn.cloudartisan.crius.R;
import cn.cloudartisan.crius.app.Constant;
import cn.cloudartisan.crius.app.Global;
import cn.cloudartisan.crius.app.URLConstant;
import cn.cloudartisan.crius.bean.User;
import cn.cloudartisan.crius.component.WebImageView;
import cn.cloudartisan.crius.network.FileUploader;
import cn.cloudartisan.crius.network.HttpAPIRequester;
import cn.cloudartisan.crius.ui.base.BaseActivity;
import cn.cloudartisan.crius.ui.util.ImageChoiceActivity;
import cn.cloudartisan.crius.util.FileURLBuilder;
import cn.cloudartisan.crius.util.StringUtils;
import cn.cloudartisan.crius.widget.GenderChooseDialog;
import org.apache.commons.io.FileUtils;

import java.io.File;

import static cn.cloudartisan.crius.util.AppTools.startPhotoZoom;

public class ProfileEditActivity extends BaseActivity implements GenderChooseDialog.OnChooseListener, FileUploader.OnUploadCallBack {
    GenderChooseDialog genderDialog;
    ImageView icon;
    User user;
    
    public void initComponents() {
        user = Global.getCurrentUser();
        setDisplayHomeAsUpEnabled(true);
        findViewById(R.id.iconSwicth).setOnClickListener(this);
        findViewById(R.id.modify_name_item).setOnClickListener(this);
        findViewById(R.id.modify_motto_item).setOnClickListener(this);
        findViewById(R.id.modify_gender_item).setOnClickListener(this);
        ((WebImageView)findViewById(R.id.icon)).load(FileURLBuilder.getUserIconUrl(user.getAccount()), R.drawable.icon_head_default);
        icon = (ImageView)findViewById(R.id.icon);
        genderDialog = new GenderChooseDialog(this, this);
    }
    
    public void onResume() {
        super.onResume();
        user = Global.getCurrentUser();
        ( (TextView)findViewById(R.id.account)).setText(user.getAccount());
        ((TextView)findViewById(R.id.name)).setText(user.getName());
        ((TextView)findViewById(R.id.motto)).setText(user.getMotto());
        if("1".equals(user.getGender())) {
            ((TextView)findViewById(R.id.gender)).setText(R.string.common_man);
        }
        if("0".equals(user.getGender())) {
            ((TextView)findViewById(R.id.gender)).setText(R.string.common_female);
        }
    }
    
    public void onClick(View v) {
        switch(v.getId()) {
            case R.id.iconSwicth:
            {
                Intent intentFromGallery = new Intent();
                intentFromGallery.setClass(this, ImageChoiceActivity.class);
                startActivityForResult(intentFromGallery, 0x9);
                break;
            }
            case R.id.modify_name_item:
            {
                Intent modiftPasswordIntent = new Intent(this, ModifyNameActivity.class);
                startActivity(modiftPasswordIntent);
                break;
            }
            case R.id.modify_gender_item:
            {
                genderDialog.show(user.getGender());
                break;
            }
            case R.id.modify_motto_item:
            {
                Intent modiftMottoIntent = new Intent(this, ModifyMottoActivity.class);
                startActivity(modiftMottoIntent);
                break;
            }
            case R.id.gender:
            {
                break;
            }
        }
    }

    private  Uri outputUri=null;
    protected void onActivityResult(int var1, int var2, Intent var3) {

        if(var2 == -1 && var1 == 9) {
outputUri=Uri.fromFile(new File(Constant.CACHE_DIR_IMAGE, StringUtils.getUUID() + ".jpg"));
            startPhotoZoom(this,outputUri);
        }

        if(var2 == -1 && var1 == 11 && var3 != null) {
            try {
                String var4 = (new Md5FileNameGenerator()).generate(FileURLBuilder.getUserIconUrl(this.user.getAccount()));

                File var6=new File(outputUri.getPath());

                this.icon.setImageBitmap(ImageLoader.getInstance().loadImageSync(Uri.fromFile(var6).toString()));
                ImageLoader.getInstance().getMemoryCache().clear();
            File var7 = new File(Constant.CACHE_DIR_IMAGE + "/" + var4);
              var7.delete();
              FileUtils.copyFile(var6,var7);
               // FileUtils.moveFile(var6, var7);
               // FileUploader.asyncUpload("lvxin-user-icon", this.user.getAccount(), var7, this);
            } catch (Exception var5) {
                var5.printStackTrace();
                return;
            }
        }

    }
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.user_profile, menu);
        return super.onCreateOptionsMenu(menu);
    }
    
    public boolean onOptionsItemSelected(MenuItem item) {
        switch(item.getItemId()) {
            case R.id.bar_menu_modify_password:
            {
                Intent modiftPasswordIntent = new Intent(this, ModifyPasswordActivity.class);
                startActivity(modiftPasswordIntent);
                break;
            }
        }
        return super.onOptionsItemSelected(item);
    }
    
    public int getConentLayout() {
        return R.layout.activity_profile_edit;
    }
    
    public int getActionBarTitle() {
        return R.string.label_setting_profile;
    }
    
    public void onGenderChecked(String gender) {
        user.setGender(gender);
        if("1".equals(gender)) {
            ((TextView)findViewById(R.id.gender)).setText(R.string.common_man);
        }
        if("0".equals(gender)) {
            ((TextView)findViewById(R.id.gender)).setText(R.string.common_female);
        }
        apiParams.put("gender", user.getGender());
        apiParams.put("account", user.getAccount());
        HttpAPIRequester.execute(apiParams,  URLConstant.USER_MODIFY_GENDER_URL);
        Global.setCurrentUser(user);
    }
    
    public void complete(String key, File file) {
        SentBody sent = new SentBody();
        sent.setKey("client_modify_logo");
        sent.put("account", user.getAccount());
        CIMPushManager.sendRequest(this, sent);
        showToast(R.string.tip_logo_updated);
    }
    
    public void onProgress(String key, float progress) {
    }
    
    public void failed(Exception e, String key) {
        showToast(R.string.tip_logo_update_error);
    }
}
