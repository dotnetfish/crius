/**
  * Generated by smali2java 1.0.0.558
  * Copyright (C) 2013 Hensence.com
  */

package cn.cloudartisan.crius.ui.contact;

import android.content.Intent;
import android.net.Uri;
import android.view.Menu;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import com.alibaba.fastjson.TypeReference;
import com.nostra13.universalimageloader.core.ImageLoader;
import cn.cloudartisan.crius.client.constant.CIMConstant;
import cn.cloudartisan.crius.R;
import cn.cloudartisan.crius.app.Global;
import cn.cloudartisan.crius.app.URLConstant;
import cn.cloudartisan.crius.bean.Group;
import cn.cloudartisan.crius.bean.Page;
import cn.cloudartisan.crius.db.GroupDBManager;
import cn.cloudartisan.crius.network.FileUploader;
import cn.cloudartisan.crius.network.HttpAPIRequester;
import cn.cloudartisan.crius.network.HttpAPIResponser;
import cn.cloudartisan.crius.ui.base.BaseActivity;
import cn.cloudartisan.crius.ui.util.ImageChoiceActivity;
import cn.cloudartisan.crius.util.AppTools;
import cn.cloudartisan.crius.util.StringUtils;
import cn.cloudartisan.crius.widget.CustomDialog;

import java.io.File;
import java.util.List;
import java.util.Map;

public class CreateGroupActivity extends BaseActivity implements FileUploader.OnUploadCallBack, View.OnClickListener, HttpAPIResponser, CustomDialog.OnOperationListener {
    CustomDialog customDialog;
    File file;
    ImageView icon;
    EditText name;
    Group newGroup=new Group();
    HttpAPIRequester requester;
    EditText summary;
    
    public void initComponents() {
        setDisplayHomeAsUpEnabled(true);
        name = (EditText)findViewById(R.id.name);
        summary = (EditText)findViewById(R.id.summary);
        icon = (ImageView)findViewById(R.id.icon);
        findViewById(R.id.iconSwitch).setOnClickListener(this);
        requester = new HttpAPIRequester(this);
        customDialog = new CustomDialog(this);
        customDialog.setOperationListener(this);
        customDialog.setTitle(R.string.label_group_create_succesed);
        customDialog.setMessage(getString(R.string.tip_group_create_succesed));
        customDialog.setButtonsText(getString(R.string.common_cancel), getString(R.string.common_confirm));
    }
    
    public void onClick(View v) {
        switch(v.getId()) {
            case R.id.button:
            {
                doCreate();
                return;
            }
            case R.id.iconSwitch:
            {
                Intent intentFromGallery = new Intent();
                intentFromGallery.setClass(this, ImageChoiceActivity.class);
                startActivityForResult(intentFromGallery, 0x9);
                break;
            }
        }
    }
    
    private void doCreate() {
        newGroup.summary = summary.getText().toString();
        if(StringUtils.isEmpty(name.getText())) {
            showToast(R.string.tip_required_name);
            return;
        }
        newGroup.name = name.getText().toString();
        newGroup.founder = Global.getCurrentUser().getAccount();
        requester.execute(new TypeReference<CreateGroupActivity>() {
            }.getType(), null, URLConstant.GROUP_CREATE_URL);
    }
    
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if(resultCode == -1 && requestCode == 9) {
            AppTools.startPhotoZoom(this, data.getData());
        }

        if(resultCode == -1 && requestCode == 11 && data != null) {
            try {
                this.file = new File(data.getData().getPath());
                ImageLoader.getInstance().displayImage(Uri.fromFile(this.file).toString(), this.icon);
            } catch (Exception var4) {
                var4.printStackTrace();
                return;
            }
        }
    }
    
    public void onSuccess(Object data, List list, Page page, String code, String url) {
        hideProgressDialog();
        if(CIMConstant.ReturnCode.CODE_200.equals(code)) {
            newGroup = (Group) data;
            if(file != null) {
                FileUploader.asyncUpload("lvxin-group-icon", newGroup.groupId, file, this);
            }
            GroupDBManager.getManager().saveGroup(newGroup);
            customDialog.show();
        }
    }
    
    public void onFailed(Exception e) {
        hideProgressDialog();
    }
    
    public Map getRequestParams(String code) {
        apiParams.put("name", newGroup.name);
        apiParams.put("founder", newGroup.founder);
        apiParams.put("summary", newGroup.summary);
        return apiParams;
    }
    
    public void onRequest() {
        showProgressDialog(getString(R.string.tip_loading, new Object[] {getString(R.string.common_create)}));
    }
    
    public void complete(String key, File file) {
       /* try {
            FileUtils.moveFile(file,
                    ("/".append(new Md5FileNameGenerator().generate(
                            FileURLBuilder.getGroupIconUrl(newGroup.groupId))).toString()));
            return;
        } catch(IOException e) {
            e.printStackTrace();
        }*/
    }
    
    public void failed(Exception e, String key) {
    }
    
    public int getConentLayout() {
        return R.layout.activity_create_group;
    }
    
    public int getActionBarTitle() {
        return R.string.label_group_create;
    }
    
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.single_button, menu);
        Button button = (Button)menu.findItem(R.id.menu_button).getActionView().findViewById(R.id.button);
        button.setOnClickListener(this);
        button.setText(R.string.common_create);
        return super.onCreateOptionsMenu(menu);
    }
    
    public void onLeftClick() {
        customDialog.dismiss();
        finish();
    }
    
    public void onRightClick() {
        customDialog.dismiss();
        Intent intent = new Intent();
        intent.putExtra("group", newGroup);
        intent.setClass(this, InviteGroupMemberActivity.class);
        startActivity(intent);
        finish();
    }
    
    public void onProgress(String key, float progress) {
    }
}
